{
  "version": 3,
  "sources": ["../../../../src/lib/common/session.ts"],
  "sourcesContent": ["type SessionData = Record<string, any>;\n\ntype Session = {\n    Store: any;\n};\n\n// TODO: in the long term move this file somewhere where we have types access it is nowhere used in controller itself and just exported for adapters so it should go to js-controller-adapter package\ninterface AdapterStoreOptions {\n    /** The ioBroker adapter */\n    adapter: any;\n    /** The cookie */\n    cookie?: {\n        maxAge?: number;\n        originalMaxAge?: number;\n    };\n}\n\n/**\n * Function to create an AdapterStore constructor\n *\n * @param session The session object, like \"express-session\"\n * @param defaultTtl the default time to live in seconds\n * @returns the constructor to create a new AdapterStore\n */\nexport function createAdapterStore(session: Session, defaultTtl = 3600): any {\n    const Store = session.Store;\n\n    class AdapterStore extends Store {\n        private readonly adapter: any;\n\n        constructor(options: AdapterStoreOptions) {\n            super(options);\n\n            this.adapter = options.adapter;\n\n            options = options || {};\n            if (!options.cookie) {\n                options.cookie = { maxAge: defaultTtl };\n            }\n            Store.call(this, options);\n        }\n\n        /**\n         * Attempt to fetch session by the given `sid`.\n         *\n         * @param sid Session ID\n         * @param fn callback\n         */\n        get(sid: string, fn: (err?: Error | string | null, obj?: SessionData) => void): void {\n            this.adapter.getSession(sid, (obj: SessionData): void => {\n                if (obj) {\n                    if (fn) {\n                        return fn(null, obj);\n                    }\n                } else if (fn) {\n                    return fn();\n                }\n            });\n        }\n\n        /**\n         * Commit the given `sess` object associated with the given `sid`.\n         *\n         * @param sid Session ID\n         * @param sess the session\n         * @param fn callback\n         */\n        set(sid: string, sess: SessionData, fn: (err?: Error | null) => void): void;\n        /**\n         * Commit the given `sess` object associated with the given `sid`.\n         *\n         * @param sid Session ID\n         * @param ttl Time to live\n         * @param sess the session\n         * @param fn callback\n         */\n        set(sid: string, ttl: number, sess: SessionData, fn: (err?: Error | null) => void): void;\n\n        /**\n         * Commit the given `sess` object associated with the given `sid`.\n         *\n         * @param sid Session ID\n         * @param ttl Time to live\n         * @param sess the session\n         * @param fn callback\n         */\n        set(sid: unknown, ttl: unknown, sess: unknown, fn?: unknown): void {\n            if (typeof sess === 'function') {\n                fn = sess as (err?: Error | null) => void;\n                sess = ttl;\n                // analyse if the session is stored directly from express session\n                ttl = (sess as SessionData)?.cookie?.originalMaxAge\n                    ? Math.round((sess as SessionData).cookie.originalMaxAge / 1000)\n                    : defaultTtl;\n            }\n            ttl = ttl || defaultTtl;\n            this.adapter.setSession(\n                sid as string,\n                ttl as number,\n                sess as SessionData,\n                function (err?: Error | null): void {\n                    // @ts-expect-error fix later\n                    fn?.call(this, err);\n                },\n            ); // do not use here => !!!\n        }\n\n        /**\n         * Destroy the session associated with the given `sid`.\n         *\n         * @param sid Session ID\n         * @param fn callback\n         */\n        destroy(sid: string, fn: () => void): void {\n            this.adapter.destroySession(sid, fn);\n        }\n    }\n\n    return AdapterStore;\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAiBA;;;;;AAOM,SAAU,mBAAmB,SAAkB,aAAa,MAAI;AAClE,QAAM,QAAQ,QAAQ;EAEtB,MAAM,qBAAqB,MAAK;IACX;IAEjB,YAAY,SAA4B;AACpC,YAAM,OAAO;AAEb,WAAK,UAAU,QAAQ;AAEvB,gBAAU,WAAW,CAAA;AACrB,UAAI,CAAC,QAAQ,QAAQ;AACjB,gBAAQ,SAAS,EAAE,QAAQ,WAAU;MACzC;AACA,YAAM,KAAK,MAAM,OAAO;IAC5B;;;;;;;IAQA,IAAI,KAAa,IAA4D;AACzE,WAAK,QAAQ,WAAW,KAAK,CAAC,QAA0B;AACpD,YAAI,KAAK;AACL,cAAI,IAAI;AACJ,mBAAO,GAAG,MAAM,GAAG;UACvB;QACJ,WAAW,IAAI;AACX,iBAAO,GAAE;QACb;MACJ,CAAC;IACL;;;;;;;;;IA4BA,IAAI,KAAc,KAAc,MAAe,IAAY;AACvD,UAAI,OAAO,SAAS,YAAY;AAC5B,aAAK;AACL,eAAO;AAEP,cAAO,MAAsB,QAAQ,iBAC/B,KAAK,MAAO,KAAqB,OAAO,iBAAiB,GAAI,IAC7D;MACV;AACA,YAAM,OAAO;AACb,WAAK,QAAQ,WACT,KACA,KACA,MACA,SAAU,KAAkB;AAExB,YAAI,KAAK,MAAM,GAAG;MACtB,CAAC;IAET;;;;;;;IAQA,QAAQ,KAAa,IAAc;AAC/B,WAAK,QAAQ,eAAe,KAAK,EAAE;IACvC;;AAGJ,SAAO;AACX;",
  "names": []
}
